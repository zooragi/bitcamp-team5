<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.welcomeToJeju.moj.dao.ThemeDao">
  <resultMap type="Theme" id="ThemeMap">
    <id column="theme_no" property="no"/> 
    <result column="title" property="title"/>
    <result column="public" property="public"/>
    <result column="created_dt" property="registeredDate"/>
    <result column="reported_cnt" property="reportedCount"/>
    <result column="view_cnt" property="viewCount"/>
    
    <association property="owner" javaType="User">
  	  <id column="owner_no" property="no"/> 
	    <result column="owner_nickname" property="nickname"/>
	    <result column="owner_email" property="email"/>
    </association>
    
    <association property="category" javaType="Category">
	    <id column="category_no" property="no"/>
	    <result column="category_name" property="name"/>
    </association>
     
    <collection property="hashtags" ofType="String">
	    <result column="hashtag_name"/>
    </collection>
    
  </resultMap>
  
  <resultMap type="Category" id="CategoryMap">
    <id column="category_no" property="no"/>
	  <result column="name" property="name"/>
  </resultMap>
  
  <select id="findAll" resultMap="ThemeMap">
  	 select 
  		t.theme_no, 
  		user_no owner_no,
  		title, 
  		public,
  		view_cnt,
  		reported_cnt,
  		c.name category_name,
  		h.name hashtag_name
  	from
  		jeju_theme t
 			left outer join jeju_theme_hashtag h on t.theme_no=h.theme_no
 			join jeju_theme_category c on c.category_no=t.category_no
  </select>
  
  <select id="findByUserNo" resultMap="ThemeMap" parameterType="int">
  	select 
  		t.theme_no, 
  		user_no owner_no,
  		title, 
  		public, 
  		view_cnt,
  		reported_cnt,
  		c.name category_name,
  		h.name hashtag_name
  	from
  		jeju_theme t
 			left outer join jeju_theme_hashtag h on t.theme_no=h.theme_no
 			join jeju_theme_category c on c.category_no=t.category_no
  	where 
  		user_no=#{no}
  </select>
  
  <update id="update" parameterType="theme">
  	update jeju_theme set 
  		title=#{title}, 
  		public=#{public}, 
  		category_no=#{category.no} 
  	where 
  		theme_no=#{no}
  </update>
  
  <update id="viewCountUpdate" parameterType="map">
  	update jeju_theme set 
  		view_cnt=#{viewCnt}
  	where 
  		theme_no=#{themeNo}
  </update>
  
  <update id="reportedCountUpdate" parameterType="map">
  	update jeju_theme set 
  		reported_cnt=#{reportedCnt}
  	where 
  		theme_no=#{themeNo}
  </update>
  
  <delete id="delete" parameterType="int">
  	delete from jeju_theme where theme_no=#{no}
  </delete>
  
  <delete id="likedThemeDelete" parameterType="map">
  	delete from jeju_liked_theme where user_no=#{userNo} and theme_no=#{themeNo} 
  </delete>
  
  <delete id="likedThemeAllDelete" parameterType="int">
  	delete from jeju_liked_theme where user_no=#{userNo} and theme_no=#{themeNo}
  </delete>
  
  <delete id="hashtagDelete" parameterType="int">
  	delete from jeju_theme_hashtag where theme_no=#{no}
  </delete>
  
  <select id="findAllCategory" resultMap="CategoryMap">
  	select
  		category_no,
  		name
  	from 
  		jeju_theme_category
  </select>
  
  <select id="findByTitle" resultMap="ThemeMap" parameterType="String">
   	select 
  		t.theme_no, 
  		user_no owner_no,
  		title, 
  		public, 
  		view_cnt,
  		reported_cnt,
  		c.name category_name,
  		h.name hashtag_name
  	from
  		jeju_theme t
 			left outer join jeju_theme_hashtag h on t.theme_no=h.theme_no
 			join jeju_theme_category c on c.category_no=t.category_no
  	where 
  		t.title=#{title}
  </select>
  
  <select id="hashtagSearch" resultMap="ThemeMap" parameterType="String">
    select
			title,
			user_no owner_no,
			th.name hashtag_name
		from
			jeju_theme t
			join jeju_theme_hashtag th on t.theme_no=th.theme_no
		where th.name=#{name};
  </select>

  <select id="likedThemeList" resultMap="ThemeMap" parameterType="int">
    select
			t.theme_no,
			t.title,
			t.user_no owner_no,
			th.name hashtag_name,
			lt.user_no
		from
			jeju_theme t
			left outer join jeju_theme_hashtag th on t.theme_no=th.theme_no
			left outer join jeju_liked_theme lt on t.theme_no=lt.theme_no
		where
			lt.user_no=#{no}
  </select>
 
	<insert id="insert" parameterType="theme"
		useGeneratedKeys="true" keyColumn="theme_no" keyProperty="no">
		Insert into jeju_theme(user_no,title,public,category_no)
		values(#{owner.no},#{title},#{public},#{category.no})
	</insert>
	
	<insert id="likedThemeInsert" parameterType="map">
		Insert into jeju_liked_theme(user_no, theme_no)
		values(#{userNo},#{themeNo})
	</insert>
	
	<insert id="insertHashtags" parameterType="map">
		insert into jeju_theme_hashtag(theme_no, name)
		values(#{themeNo},#{name})
	</insert>

</mapper>







